<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>Shenzm_发布文章</title>
    <link rel="stylesheet" href="/inputpublic/css/style.css" />
    <link rel="stylesheet" href="/inputpublic/css/editormd.css" />
    <script src="/inputpublic/js/jquery.min.js"></script>
    <script src="/inputpublic/js/editormd.js"></script>
    <script type="text/javascript">
    var editor;
    var userid;
    $(function() {
        $.ajax({
            type: "POST",
            url: "/xhr/session",
            contentType: "application/json;",
            data: JSON.stringify({
                method: "sync"
            }),
            dataType: "json",
            success: function(result) {
                if (result.result && !result.result.error) {
                    if (result.result.id) {
                        $("#layout").show();
                        userid = result.result.id;
                    } else {
                        $("#layout").hide();
                        localStorage.setItem("token", result.result.token);
                        window.location.href = "/login.html";
                    }
                } else {
                    alert("session fail");
                }
            },
            error: function(message) {
                alert("session error");
            }
        });

        editor = editormd("test-editormd", {
            width: "90%",
            height: 888,
            path: "/inputpublic/lib/",
            htmlDecode: "style,script,iframe",
            placeholder: "写点什么吧。。。",
            imageUpload:true,
            imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
            imageUploadURL:"/rest/storage/attachment",
            emoji: true,
            taskList: true,
            flowChart: true,
            sequenceDiagram: true
        });

        $("#submitbtn").click(function() {
            var title = $("#title").val();
            var content = editor.getMarkdown();

            if (!title) {
                alert("请输入标题！");
                return;
            }
            
            if (!content) {
                alert("请输入内容！");
                return;
            }

            $.ajax({
                type: "POST",
                url: "/xhr/" + userid + "/blog",
                contentType: "application/json;",
                data: JSON.stringify({
                    method: "post",
                    params: [{
                        title: title,
                        content: content,
                        userid: userid
                    }]
                }),
                dataType: "json",
                success: function(result) {
                    if (result.result && !result.result.error) {
                        alert("发布成功！");
                        window.location.href = "/blog/message." + result.result;
                    } else {
                        alert("发布失败！");
                    }
                },
                error: function(message) {
                    alert("submit error");
                }
            });
        });
    });
    </script>
</head>

<body>
    <div id="layout" style="display:none;">
        <div style="margin-left:5%;margin-top: 2%;">
            <div>
                <span>标题：</span>
                <input type="text" id="title" style="width:800px;height:30px;" />
                <input type="submit" id="submitbtn" class="btn" value="发布" style="width:80px;" />
            </div>
        </div>
        <br/>
        <div id="test-editormd">
            <textarea style="display:none;"></textarea>
        </div>
    </div>
</body>

</html>