<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>Shenzm_发布文章</title>
    <link rel="stylesheet" href="/inputpublic/css/style.css" />
    <link rel="stylesheet" href="/inputpublic/css/editormd.css" />
    <style type="text/css">
        .item {
            margin-bottom: 5px;
        }
        
        span.btn {
            position: relative;
            font-size: 12px;
            color: #000;
        }

        .btn:hover {
            color: #fff;
            background: #e37100; 
        }

        #postimg {
            position: absolute;
            right: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="/inputpublic/js/jquery.min.js"></script>
    <script src="/inputpublic/js/upload.js"></script>
    <script src="/inputpublic/js/editormd.js"></script>
    <script type="text/javascript">
    var editor;

    var queryString = function() {
        let vars = {},
            hash,
            i,
            hashes = window.location.search.slice(1).split('&');

        for (i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars[hash[0]] = hash[1];
        }
        return vars;
    }

    $(function() {
        var qs = queryString();
        $.ajax({
            type: "POST",
            url: "/user/auth",
            data: {
                token: qs.token
            },
            success: function(result) {
                if (result.res) {
                        document.cookie = 'blogtoken=' + qs.token + ";path=/";
                        
                        $("#layout").show();
                        editor = editormd("test-editormd", {
                            width: "90%",
                            height: 888,
                            path: "/inputpublic/lib/",
                            htmlDecode: "style,script,iframe",
                            placeholder: "写点什么吧。。。",
                            imageUpload:true,
                            imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                            imageUploadURL:"/rest/storage/attachment",
                            emoji: true,
                            taskList: true,
                            flowChart: true,
                            sequenceDiagram: true
                        });

                        $("#submitbtn").click(function() {
                            var title = $("#title").val();
                            var tag = $("#tag").val();
                            var summary = $("#summary").val();
                            var content = editor.getMarkdown();
                            var img = $('#preview').attr('src');

                            if (!title || !tag || !summary || !content || !img) {
                                alert("请检查是否有缺失内容！");
                                return;
                            }
                            $.ajax({
                                type: "POST",
                                url: "/blog/postblog",
                                data: {
                                    title: title,
                                    tag: tag,
                                    img: img,
                                    summary: summary,
                                    content: content
                                },
                                success: function(result) {
                                    if (result && result.res === 'success') {
                                        alert("发布成功！");
                                    } else {
                                        alert("发布失败！");
                                    }
                                },
                                error: function(message) {
                                    alert("submit error");
                                }
                            });
                        });

                        var changefn = function(){
                            $(this).uploadFile({
                                url: '/blog/postimg',
                                html5Mode: true,
                                success: function(data, $element) {
                                    if (data.key) {
                                        $('#preview').attr('src', "//img.shenzm.cn/" + data.key);    
                                    }
                                    $('#postimg').replaceWith('<input id="postimg" type="file" name="imgfile" accept="image/*" />');
                                    $('#postimg').on('change', changefn);
                                }
                            });
                        }
                        $('#postimg').change(changefn);
                } else {
                    alert("login fail");
                }
            },
            error: function(message) {
                alert("login error");
            }
        });
    });

    </script>
</head>

<body>
    <div id="layout" style="display:none;">
        <div style="margin-left:5%;margin-top: 2%;">
            <div class="item">
                <span>标题：</span>
                <input type="text" id="title" style="width:300px;height:30px;" />
                <input type="button" id="submitbtn" class="btn" value="发布" style="width:80px;" />
                <span class="btn">上传背景图<input id="postimg" type="file" name="imgfile" accept="image/*" /></span>
            </div>
            <div class="item">
                <span>标签：</span>
                <input type="text" id="tag" style="width:300px;height:30px;" />
            </div>
            <div class="item">
                <span style="vertical-align: top;">概要：</span>
                <textarea id="summary" style="width:500px;height:100px;"></textarea>
                <img id="preview" style="width:200px;height:100px;vertical-align: baseline;" />
            </div>
        </div>
        <br/>
        <div id="test-editormd">
            <textarea style="display:none;"></textarea>
        </div>
    </div>
</body>

</html>