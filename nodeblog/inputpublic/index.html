<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>Shenzm_发布文章</title>
    <link rel="stylesheet" href="/inputpublic/css/style.css" />
    <link rel="stylesheet" href="/inputpublic/css/editormd.css" />
    <script src="/inputpublic/js/jquery.min.js"></script>
    <script src="/inputpublic/js/editormd.js"></script>
    <script type="text/javascript">
    var editor;

    var queryString = function() {
        let vars = {},
            hash,
            i,
            hashes = window.location.search.slice(1).split('&');

        for (i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars[hash[0]] = hash[1];
        }
        return vars;
    }

    $(function() {
        var qs = queryString();
        $.ajax({
            type: "POST",
            url: "/auth/login",
            data: {
                token: qs.token
            }
            success: function(result) {
                if (result.res) {
                        $("#layout").show();

                        editor = editormd("test-editormd", {
                            width: "90%",
                            height: 888,
                            path: "/inputpublic/lib/",
                            htmlDecode: "style,script,iframe",
                            placeholder: "写点什么吧。。。",
                            imageUpload:true,
                            imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                            imageUploadURL:"/rest/storage/attachment",
                            emoji: true,
                            taskList: true,
                            flowChart: true,
                            sequenceDiagram: true
                        });

                        $("#submitbtn").click(function() {
                            var title = $("#title").val();
                            var content = editor.getMarkdown();

                            if (!title) {
                                alert("请输入标题！");
                                return;
                            }
                            
                            if (!content) {
                                alert("请输入内容！");
                                return;
                            }

                            $.ajax({
                                type: "POST",
                                url: "/blog/postblog",
                                data: {
                                    title: title,
                                    content: content,
                                },
                                success: function(result) {
                                    if (result.result && !result.result.error) {
                                        alert("发布成功！");
                                    } else {
                                        alert("发布失败！");
                                    }
                                },
                                error: function(message) {
                                    alert("submit error");
                                }
                            });
                        });
                } else {
                    alert("login fail");
                }
            },
            error: function(message) {
                alert("login error");
            }
        });
    });
    </script>
</head>

<body>
    <div id="layout" style="display:none;">
        <div style="margin-left:5%;margin-top: 2%;">
            <div>
                <span>标题：</span>
                <input type="text" id="title" style="width:800px;height:30px;" />
                <input type="submit" id="submitbtn" class="btn" value="发布" style="width:80px;" />
            </div>
        </div>
        <br/>
        <div id="test-editormd">
            <textarea style="display:none;"></textarea>
        </div>
    </div>
</body>

</html>